{% extends "standard.html" %}

{% block content %}

<style type="text/css">
    #gMap {
       height:100%; 
       width:100%;
    }
    #content {
       height:100%;
    }
</style>
   

<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDY0kkJiTPVd2U7aTOAwhc9ySH6oHxOIYM&sensor=true"></script>
<script src='{{ STATIC_URL }}js/markerclusterer.js'></script>

<script>
google.maps.visualRefresh = true;
var map = null;
var initialLocation = null;
var cluster = null;
var santaCruz = new google.maps.LatLng(36.973, -122.029);
var LA = new google.maps.LatLng(34.052, -118.243);
var flagbrown = '{{ STATIC_URL }}images/flagbrown.png';
var flaggreen = '{{ STATIC_URL }}images/flaggreen.png'; 
var flagsilver = '{{ STATIC_URL }}images/flagsilver.png';
var flagred = '{{ STATIC_URL }}images/flagred.png';
var flagyellow = '{{ STATIC_URL }}images/flagyellow.png';
var flags = new Array(flagred, flagbrown, flagyellow, flagsilver, flaggreen);

// styles for the cluster.
var clusterStyle = { 
   styles: [{
     url: '../static/images/toiletvanilla.png',
     height: 35,
     width: 35,
     textColor: '#ff00ff',
     textSize: 10
   }, {
     url: '{{ STATIC_URL }}images/toiletsilver.png',
     height: 45,
     width: 45, 
     textColor: '#000000',
     textSize: 11
   }, {
     url: '{{ STATIC_URL }}images/toiletgold.png',
     height: 55,
     width: 55,
     textColor: '#DC143C',
     textSize: 12,
     anchor: [-15,0]
   }],
   maxZoom:10,
   gridSize:50,

   };

function createMarkerClusters() {
    if (cluster) {
        cluster.clearMarkers();
    }
    var markerlist = [];
    // modify this query if the data gets larger than 10k
    var jq = tapi({noun: 'toilet', verb: 'retrieve'});
    jq.done(function(data)  {
      $.each(data, function (i, t) {  
        var latLng = new google.maps.LatLng(t.fields.lat, t.fields.lng);
        var marker = new google.maps.Marker({
          position: latLng,
          draggable: false,
	  icon: flags[t.fields.rating]
        });
	markerlist.push(marker);
      });
    cluster = new MarkerClusterer(map, markerlist, clusterStyle);
    });
}

function initialize() {
    var options = {
        zoom:2,
        mapTypeId:google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("gMap"), options);
    google.maps.event.addListener(map, "click", function () {
        infowindow.close();
    });
    // get current location and drop marker for the current location.
    if (navigator.geolocation) {
	navigator.geolocation.getCurrentPosition(function(position) {
          initialLocation = new google.maps.LatLng(position.coords.latitude, 
                                                   position.coords.longitude);
	  map.setCenter(initialLocation);
          createCurrentLocationMarker(initialLocation);
	  createMarkerClusters();
        }, function () {
          handleGeolocation(true);
        });
    } else {
        handleGeolocation(false);
    }
}


function handleGeolocation(supportFlag) { 
    if (supportFlag == true) {
          alert("Geolocation Service Failed. Placing you in LA.");
    } else {
          alert("Browser Doesn't Support Geolocation. Placing you in LA.");
    }
    map.setCenter(LA);
}
    
function createCurrentLocationMarker(gps) {
    var image = '{{ STATIC_URL }}images/currentlocation.png';
    var marker = new google.maps.Marker({
       position: gps,
       animation: google.maps.Animation.DROP,
       title: "Your Current Location",
       icon: image
    });
    // add markers to the map
    showCurrentLocationWindow(marker);
    marker.setMap(map);
}

var infowindow = new google.maps.InfoWindow ({
    map:map,
});
function showCurrentLocationWindow(marker) {
    google.maps.event.addListener(marker, "click", function() {
        infowindow.setContent('Current Location');
	infowindow.open(map, marker);
    });
}

function createInfoWindow(marker, str, info) {
    google.maps.event.addListener(marker, "click" ,function() {
        infowindow.open(map, marker);
    });
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>

<div id="gMap"></div>

{% endblock %}



